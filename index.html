<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Wallet Prank</title>
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon.png">
  <style>
    /* === PERFECTED CSS === */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      background: #000; 
      color: white; 
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      height: 100vh;
      overflow: hidden;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      height: 80px;
      position: relative;
      z-index: 100;
    }

    .title { font-size: 34px; font-weight: 700; }

    .controls { display: flex; gap: 8px; }
    .control-btn {
      width: 44px; height: 44px;
      background: #fff; border-radius: 22px;
      display: flex; align-items: center; justify-content: center;
    }
    .control-btn img { width: 24px; height: 24px; display: block; }

    #cardContainer {
      position: relative;
      height: calc(100vh - 100px);
      overflow-y: auto;
      padding: 0 12px;
    }

    .card {
      position: absolute;
      width: 100%;
      max-width: 375px;
      left: 50%;
      transform: translateX(-50%);
      border-radius: 12px;
      overflow: hidden;
      transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }

    /* Credit Card Styling */
    .card[data-type="credit"] {
      aspect-ratio: 1084/684;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    /* Loyalty Card Styling */
    .card[data-type="loyalty"] {
      aspect-ratio: 1066/1491;
      max-height: 300px; /* Show only top 20% */
      transition: max-height 0.4s ease;
    }

    .card.active[data-type="loyalty"] {
      max-height: 80vh; /* Show full card when active */
    }

    .card img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    /* Card Stacking */
    .card:not(.active) {
      top: calc(var(--stack-index) * 60px);
      z-index: var(--stack-index);
    }

    .card.active {
      top: 50% !important;
      left: 50% !important;
      transform: translate(-50%, -50%) !important;
      z-index: 999 !important;
      width: 94% !important;
      max-height: 80vh !important;
    }

    #done-btn {
      position: fixed;
      top: 24px;
      left: 24px;
      color: white;
      font-size: 20px;
      z-index: 1000;
      display: none;
      background: transparent;
      border: none;
    }

    #done-btn.visible { display: block; }

    .popup {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #1c1c1e;
      padding: 1.5rem 1rem;
      border-radius: 24px 24px 0 0;
      transform: translateY(100%);
      transition: transform 0.3s ease;
      z-index: 1000;
    }
    .popup.visible { transform: translateY(0); }
    .popup button {
      width: 100%;
      padding: 1rem;
      background: #363638;
      color: white;
      border: none;
      border-radius: 12px;
      margin-bottom: 8px;
    }
  </style>
</head>
<body>
  <!-- Same HTML structure as before -->
  <header>...</header>
  <div id="cardContainer"></div>
  <button id="done-btn">Done</button>
  <div id="popup" class="popup">...</div>

  <script>
    // === PERFECTED JAVASCRIPT ===
    let cards = [];
    const STACK_OFFSET = 60; // Half card overlap

    function stackCards() {
      cards.forEach((card, index) => {
        card.style.setProperty('--stack-index', index);
        card.style.zIndex = index;
        card.style.top = `${index * STACK_OFFSET}px`;
        
        // Smooth scroll to new cards
        if(index === cards.length - 1) {
          card.scrollIntoView({
            behavior: 'smooth',
            block: 'end'
          });
        }
      });
    }

    function createCard(file, isLoyalty) {
      const reader = new FileReader();
      reader.onload = e => {
        const card = document.createElement('div');
        card.className = 'card';
        card.dataset.type = isLoyalty ? 'loyalty' : 'credit';
        
        const img = new Image();
        img.src = e.target.result;
        card.appendChild(img);

        card.addEventListener('click', () => {
          cards.forEach(c => c.classList.remove('active'));
          card.classList.add('active');
          document.querySelector('header').style.display = 'none';
          document.getElementById('done-btn').classList.add('visible');
          
          // Hide other cards during animation
          setTimeout(() => {
            cards.forEach(c => {
              if(c !== card) c.style.opacity = '0';
            });
          }, 100);
        });

        cards.push(card);
        document.getElementById('cardContainer').appendChild(card);
        stackCards();
      };
      reader.readAsDataURL(file);
    }

    document.getElementById('done-btn').addEventListener('click', () => {
      cards.forEach(card => {
        card.classList.remove('active');
        card.style.opacity = '1';
      });
      document.querySelector('header').style.display = 'flex';
      document.getElementById('done-btn').classList.remove('visible');
      stackCards(); // Re-stack cards properly
    });

    // Rest of the script remains same
  </script>
</body>
</html>
